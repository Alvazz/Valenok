# Valenok. Низкоуровневые технические требования.

## Состав и компоновка контроллера

Электрическая часть контроллера конструктивно состоит из трех основных плат:
 
 * Силовая плата.
 * Плата управления.
 * Плата звена постоянного тока. 
 
На плату управления может дополнительно устанавливаться плата расширения с разъемами. 

## Силовая плата

Силовая плата представляет из себя одностороннюю плату на алюминиевом основани.
Количество слоев меди - 1 или 2.
Толщина медного покрытия каждого слоя - не менее 100 мкм. 

Инвертор собирается на транзисторах [BSC077N12NS3GATMA1](https://www.digikey.com/en/products/detail/infineon-technologies/BSC077N12NS3GATMA1/2337847).
Транзисторы включаются параллельно по 3 шт. В цепи затвора каждого транзистора должен быть включен резистор. Номинал резистора рассчитывается исходя из емкости затвора и
максимального тока драйвера. Необходимо также установить по общему резистору на каждой из затворных цепей драйвера. На первой итерации они будет заменены перемычкой.
Но в дальнейшем они могут использоваться для борьбы со звоном затворных цепей транзисторов. 

Рядом с каждым транзисторным полумостом на плате устанавливается драйвер. 
Требования к полумостовому драйверу:
 
 * Максимальный ток - не менее 3 А, лучше 4 А.
 * Максимальное напряжение полумоста - не менее 120 В.
 * Раздельное независимое управление верхним и нижним транзисторами. 
 * Встроенная UVLO защита. 
 * Встроенная защита от сквозного тока.

Например, драйвер [UCC27282](https://www.ti.com/lit/ds/snvsaq5a/snvsaq5a.pdf?ts=1602424164509).

## Плата управления

### Микроконтроллер
Плата управления собирается на базе микроконтроллера [ST32F105CT7](https://www.st.com/en/microcontrollers-microprocessors/stm32f105-107.html).
Схема подключения микроконтроллера должна быть совместима с прошивкой [Sapog](https://github.com/px4/sapog). 

`HW_ID` код для Valenok ESC `0x03`.

### Интерфейсы

На плате управления должны быть выведены следующие интерфейсы
1. **RS-232**. Интерфейс для отладки и конфигурирования контроллера с помощью CLI. Наружу выводятся только 3 сигнала: RX, TX и GND.
2. **SWD**. Интерфейс для прошивки на производстве. Используются 2 линии: SWCLK и SWDIO, - которые выводятся на TP, с обратной стороны платы.
3. **RCPWM**. Интерфейс для формирования сигнала задания с помощью ШИМ сигнала напряжением 5V. Наружу выводится только один сигнал и GND.
4. **ISO 11898-2 CAN 2.0B**. Подключение к шине CAN производится с помощью двух распараллеленных разъемов JST SM04B-GHS в соответствии с DS015 UAVCAN 
Drone Standard. 
Распиновка разъемов представлена ниже

| Pin no. | Type        | Function         | Comment         | 
| ------- |-------------| ---------------- | --------------- |
|    1    | Power       | Bus power supply | +5 V            |
|    2    |Input/output |    CAN high      |                 |
|    3    |Input/output |    CAN low       |                 |
|	   4    | Ground      |     Ground       |                 |

5. **PTC термистор**. К плате может быть подключен PTC термистор типа [KTY-84/130](https://www.nxp.com/docs/en/data-sheet/KTY84_SER.pdf?).
На плате управления размещается подтягивающий к питанию 3.3 В резистор 1.2K 1%. Термистор подключается между AGND и выводом подтяигивающего резистора.
Напряжение с термистора заводится на один из каналов АЦП микроконтроллера.

### Шина питания

В контроллере должна быть реализована схема питания, представленная на рис. 1.

![Рис. 1.](/docs/Figures/power_scheme.SVG "Рис. 1. Схема питания Valenok").

Такой вариант питания исключает опасность перезагрузки контроллера в полете в случае перегрузки по цепи питания BEC.
Возможно подключение шины питания 3.3V к шине 5V через LDO, однако в этом случае следует увеличить   максимальное 
значение тока шины 5V как минимум в 2 раза, чтобы предохранитель успел сработать раньше, чем напряжение на микроконтроллере 
просядет ниже критического уровня.

## Плата конденсаторов

Плата конденсаторов предназначена для размещения на ней Bulk конденсаторов. 
Суммарная ёмкость должна быть не менее 400 uF.
Конденсаторы размещаются вертикально. 
Желательно использовать конденсаторы для планарного монтажа, чтобы плату можно было прикрепить к верхней крышке корпуса. 
Через плату возможно также отведение тепла от конденсаторов на корпус. 
Плату можно соединять с силовой платой при помощи гибких проводов AWG12. 
Силовые провода питания от батареи необходимо подключать к плате конденсаторов так, чтобы путь протекания силового тока проходил через 
все конденсаторы и потом уходил на силовую плату. 

## Корпус

Корпус контроллера собирается из двух алюминиевых частей. 

Для уменьшения себестоимости в качестве части корпуса, к которой крепится силовая алюминиевая плата, может быть использован готовый алюминиевый радиатор, 
полученный методом экструзии. При этом должны быть соблюдены следующие требования:
 - Ребра радиатора должны иметь площадь, достаточную для отвода тепла на максимальной мощности контроллера при температуре окружающей среды 20С и коэффициенте
 конвекции 350 W/(m2K).
 - Толщина основания радиатора должна быть достаточной для того, чтобы на нем можно было закрепить крышку и силовую плату с помощью винтов и при этом не было 
 сквозных отверстий в радиаторе. 
 
 Вторая часть корпуса - фрезерованная алюминиевая крышка. Крышка должна придавать контроллеру эстетически привелкательный вид. Поэтому использование пластиковых 
 деталей не допускается. На торцевых частях крышки располагаются отверстия / вырезы для силовых проводов и подключения проводов управления.
 С одного торца выводятся 3 провода AWG12 для подключения к мотору. 
 С другого конца выводятся:
  * 2 провода питания (AWG 12).
  * 2 разъема UAVCAN
  * Разъем AUX, на который выведены RCPWM, RS232 и термистор.
  
  Допускается выведение интерфейса RS232 через отдельный разъем, расположенный на боковой стенке контроллера. При этом необходимо предусмотреть резиновую заглушку
  для защиты от влаги и пыли, как, например, показано на рис.2.
  
  ![Рис.2. Расположение разъема на боковой стенке контроллера](/docs/Figures/KDE-UAS125UVC_2_2048x2048.jpg).
  
  Все остальные провода должны заводиться в корпус контроллера при помощи резиновых / силиконовых сальников, как, например, показано на рис. 3.
  
  ![Рис.3. Разъемы и провода на торцевых стенках контроллера](/docs/Figures/dji_tycon.jpeg).
  
  Обе части контроллера должны скрепляться между собой винтами. Головки винтов не должны выделяться, чтобы не портить эстетический вид контроллера. 
  Количество винтов не должно быть более 6.
